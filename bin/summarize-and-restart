#!/bin/bash
# Summarize session then restart it.
# Used by PreCompact hook to preserve context across compaction.
#
# Usage: summarize-and-restart <session_name>

set -e

SESSION_NAME="$1"

if [ -z "$SESSION_NAME" ]; then
    echo "Usage: summarize-and-restart <session_name>" >&2
    exit 1
fi

SCRIPT_DIR="$(dirname "$0")"
LOG_FILE="$HOME/dispatch/logs/compactions.log"

log() {
    echo "$(date '+%Y-%m-%d %H:%M:%S') | $1" >> "$LOG_FILE"
}

log "HOOK | PreCompact triggered for $SESSION_NAME"

# Step 1: Generate and save summary (blocks until complete)
# If this fails, we still restart (graceful degradation)
if "$SCRIPT_DIR/summarize-session" "$SESSION_NAME"; then
    log "HOOK | Summary generated for $SESSION_NAME"
else
    log "HOOK | Summary failed for $SESSION_NAME (continuing with restart)"
fi

# Step 2: Restart the session
log "HOOK | Restarting $SESSION_NAME"
"$SCRIPT_DIR/claude-assistant" restart-session --no-compact "$SESSION_NAME"

log "HOOK | Complete for $SESSION_NAME"
