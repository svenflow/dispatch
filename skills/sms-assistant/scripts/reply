#!/usr/bin/env -S uv run --script
# /// script
# dependencies = []
# ///
"""
reply - Universal reply CLI that auto-detects backend from cwd

Usage:
    reply "message"                     # Send text
    reply --image /path/to.png          # Send image only
    reply "caption" --image /path.png   # Send text + image
    reply --file /path/to.pdf           # Send any file
"""
import sys
import json
import subprocess
import argparse
from pathlib import Path

TRANSCRIPTS_DIR = Path.home() / "transcripts"
REGISTRY_PATH = Path.home() / "dispatch/state/sessions.json"
SEND_SMS = Path.home() / ".claude/skills/sms-assistant/scripts/send-sms"
SEND_SIGNAL = Path.home() / ".claude/skills/signal/scripts/send-signal"
SEND_SIGNAL_GROUP = Path.home() / ".claude/skills/signal/scripts/send-signal-group"

def is_group_chat_id(chat_id: str) -> bool:
    bare = chat_id
    for prefix in ["signal:", "test:"]:
        if chat_id.startswith(prefix):
            bare = chat_id[len(prefix):]
            break
    return not bare.startswith("+")

def strip_registry_prefix(chat_id: str) -> str:
    for prefix in ["signal:", "test:"]:
        if chat_id.startswith(prefix):
            return chat_id[len(prefix):]
    return chat_id

def main():
    parser = argparse.ArgumentParser(description="Universal reply CLI")
    parser.add_argument("message", nargs="?", default="", help="Message text")
    parser.add_argument("--image", "-i", help="Path to image file")
    parser.add_argument("--file", "-f", help="Path to any file")
    parser.add_argument("--allow-raw-filepath", action="store_true",
                        help="Allow sending filepath as text (normally rejected)")
    args = parser.parse_args()

    if not args.message and not args.image and not args.file:
        parser.error("Must provide message, --image, or --file")

    cwd = Path.cwd()
    try:
        parts = cwd.relative_to(TRANSCRIPTS_DIR).parts
    except ValueError:
        print(f"Error: Not in transcript directory", file=sys.stderr)
        sys.exit(1)

    if len(parts) < 2:
        print("Error: Not in session directory", file=sys.stderr)
        sys.exit(1)

    backend, folder = parts[0], parts[1]
    expected_transcript_dir = str(TRANSCRIPTS_DIR / backend / folder)

    try:
        registry = json.loads(REGISTRY_PATH.read_text())
    except Exception as e:
        print(f"Error: Could not load registry: {e}", file=sys.stderr)
        sys.exit(1)

    chat_id = None
    for entry in registry.values():
        if entry.get("transcript_dir") == expected_transcript_dir:
            chat_id = entry["chat_id"]
            break

    if not chat_id:
        print(f"Error: Session not found in registry", file=sys.stderr)
        sys.exit(1)

    bare_chat_id = strip_registry_prefix(chat_id)

    if backend == "signal":
        if is_group_chat_id(chat_id):
            cmd = [str(SEND_SIGNAL_GROUP), bare_chat_id]
        else:
            cmd = [str(SEND_SIGNAL), bare_chat_id]
        # Signal CLIs take message as second positional arg
        if args.message:
            cmd.append(args.message)
        # Note: Signal image/file support would need to be added to signal CLIs
    else:
        cmd = [str(SEND_SMS), bare_chat_id]
        if args.message:
            cmd.append(args.message)
        if args.image:
            cmd.extend(["--image", args.image])
        if args.file:
            cmd.extend(["--file", args.file])
        if args.allow_raw_filepath:
            cmd.append("--allow-raw-filepath")

    result = subprocess.run(cmd)
    sys.exit(result.returncode)

if __name__ == "__main__":
    main()
