#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = []
# ///
"""
reply-sven - Store assistant response and generate TTS audio.

Called by Claude sessions to send responses to the Sven iOS app.
Stores message in SQLite message bus and generates TTS via Kokoro.

Usage:
    reply-sven <chat_id> <message>

The chat_id is typically "voice" for the main Sven app session.
"""

import argparse
import os
import sqlite3
import subprocess
import sys
import uuid
from datetime import datetime
from pathlib import Path

# Paths
DB_PATH = Path.home() / "dispatch" / "state" / "sven-messages.db"
AUDIO_DIR = Path.home() / "dispatch" / "state" / "sven-audio"
TTS_SCRIPT = Path.home() / ".claude" / "skills" / "tts" / "scripts" / "speak"


def init_db():
    """Initialize the SQLite database if it doesn't exist."""
    DB_PATH.parent.mkdir(parents=True, exist_ok=True)

    conn = sqlite3.connect(DB_PATH)
    conn.execute("""
        CREATE TABLE IF NOT EXISTS messages (
            id TEXT PRIMARY KEY,
            role TEXT NOT NULL,
            content TEXT NOT NULL,
            audio_path TEXT,
            created_at DATETIME DEFAULT CURRENT_TIMESTAMP
        )
    """)
    conn.commit()
    conn.close()


def generate_tts(text: str, output_path: Path) -> bool:
    """Generate TTS audio using Kokoro."""
    try:
        AUDIO_DIR.mkdir(parents=True, exist_ok=True)

        result = subprocess.run(
            [str(TTS_SCRIPT), text, "-o", str(output_path)],
            capture_output=True,
            text=True,
            timeout=120  # 2 minute timeout for long responses
        )

        if result.returncode != 0:
            print(f"TTS failed: {result.stderr}", file=sys.stderr)
            return False

        return output_path.exists()

    except subprocess.TimeoutExpired:
        print("TTS timed out", file=sys.stderr)
        return False
    except Exception as e:
        print(f"TTS error: {e}", file=sys.stderr)
        return False


def store_message(message_id: str, role: str, content: str, audio_path: str | None):
    """Store message in SQLite database."""
    conn = sqlite3.connect(DB_PATH)
    conn.execute(
        "INSERT INTO messages (id, role, content, audio_path) VALUES (?, ?, ?, ?)",
        (message_id, role, content, audio_path)
    )
    conn.commit()
    conn.close()


def main():
    parser = argparse.ArgumentParser(description="Store Sven app response with TTS")
    parser.add_argument("chat_id", help="Chat ID (typically 'voice')")
    parser.add_argument("message", help="Message text to send")
    args = parser.parse_args()

    if not args.message.strip():
        print("Empty message, skipping", file=sys.stderr)
        sys.exit(1)

    # Fix escaped exclamation marks from shell
    # Claude Code sometimes escapes ! as \! when calling via Bash
    message = args.message.replace("\\!", "!")

    # Initialize database
    init_db()

    # Generate unique ID
    message_id = str(uuid.uuid4())

    # Generate TTS audio
    audio_filename = f"{message_id}.wav"
    audio_path = AUDIO_DIR / audio_filename

    tts_success = generate_tts(message, audio_path)
    audio_path_str = str(audio_path) if tts_success else None

    # Store message
    store_message(message_id, "assistant", message, audio_path_str)

    print(f"Message stored: {message_id}")
    if tts_success:
        print(f"Audio generated: {audio_path}")
    else:
        print("Audio generation failed, message stored without audio")


if __name__ == "__main__":
    main()
