#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = ["httpx[http2]", "PyJWT", "cryptography"]
# ///
"""
send-push - Send rich APNs push notifications to Sven iOS app.

Usage:
    send-push <message_id> <preview_text>
    send-push --test  # Test with a simple notification
    send-push --category MESSAGE_CATEGORY --message-id <id> --body <text>
    send-push --image <url> --body <text>  # Notification with image
    send-push --audio <url> --body <text>  # Notification with audio
    send-push --report <url> --body <text>  # Notification with PDF report

Notification Categories:
    MESSAGE_CATEGORY  - Like, Reply, Dislike buttons (default)
    AUDIO_CATEGORY    - Play Audio, Like, Reply buttons
    REPORT_CATEGORY   - View Report, Like buttons
    IMAGE_CATEGORY    - Like, Reply buttons (with image attachment)

Config is in ~/dispatch/state/sven-push-config.json
"""

import argparse
import json
import sys
import time
from pathlib import Path

import httpx
import jwt

# Config paths
CONFIG_PATH = Path.home() / "dispatch" / "state" / "sven-push-config.json"
APNS_TOKENS_PATH = Path.home() / "dispatch" / "state" / "sven-apns-tokens.json"

# APNs endpoints
APNS_HOST_PROD = "https://api.push.apple.com"
APNS_HOST_SANDBOX = "https://api.sandbox.push.apple.com"


def load_config() -> dict:
    """Load push notification config."""
    if not CONFIG_PATH.exists():
        print(f"Error: Config not found at {CONFIG_PATH}", file=sys.stderr)
        sys.exit(1)

    return json.loads(CONFIG_PATH.read_text())


def create_apns_jwt(config: dict) -> str:
    """Create JWT for APNs authentication."""
    key_path = Path(config["key_path"]).expanduser()

    if not key_path.exists():
        print(f"Error: APNs key not found at {key_path}", file=sys.stderr)
        sys.exit(1)

    key = key_path.read_text()

    headers = {
        "alg": "ES256",
        "kid": config["key_id"]
    }

    payload = {
        "iss": config["team_id"],
        "iat": int(time.time())
    }

    return jwt.encode(payload, key, algorithm="ES256", headers=headers)


def send_notification(
    apns_token: str,
    message_id: str,
    body: str,
    config: dict,
    sandbox: bool = False,
    category: str = "MESSAGE_CATEGORY",
    title: str = "Sven",
    image_url: str = None,
    audio_url: str = None,
    report_url: str = None,
) -> bool:
    """Send push notification via APNs."""
    host = APNS_HOST_SANDBOX if sandbox else APNS_HOST_PROD

    token = create_apns_jwt(config)

    headers = {
        "authorization": f"bearer {token}",
        "apns-topic": config["bundle_id"],
        "apns-push-type": "alert",
        "apns-priority": "10"
    }

    # Truncate body if too long
    truncated = body[:100] + "..." if len(body) > 100 else body

    # Base payload
    payload = {
        "aps": {
            "alert": {
                "title": title,
                "body": truncated
            },
            "sound": "default",
            "badge": 1,
            "category": category,
            "mutable-content": 1  # Required for notification service extension
        },
        "message_id": message_id
    }

    # Add media URLs for service extension to process
    if image_url:
        payload["image_url"] = image_url
    if audio_url:
        payload["audio_url"] = audio_url
    if report_url:
        payload["report_url"] = report_url

    url = f"{host}/3/device/{apns_token}"

    try:
        with httpx.Client(http2=True, timeout=30) as client:
            response = client.post(
                url,
                headers=headers,
                json=payload
            )

            if response.status_code == 200:
                print(f"Push sent successfully to {apns_token[:20]}...")
                return True
            else:
                print(f"Push failed: {response.status_code} - {response.text}", file=sys.stderr)
                return False

    except Exception as e:
        print(f"Push error: {type(e).__name__}: {e}", file=sys.stderr)
        return False


def main():
    parser = argparse.ArgumentParser(description="Send rich APNs push notification")
    parser.add_argument("message_id", nargs="?", help="Message ID")
    parser.add_argument("preview", nargs="?", help="Preview text for notification (legacy positional)")
    parser.add_argument("--body", "-b", help="Notification body text")
    parser.add_argument("--title", "-t", default="Sven", help="Notification title")
    parser.add_argument("--category", "-c", default="MESSAGE_CATEGORY",
                        choices=["MESSAGE_CATEGORY", "AUDIO_CATEGORY", "REPORT_CATEGORY", "IMAGE_CATEGORY"],
                        help="Notification category (determines action buttons)")
    parser.add_argument("--image", help="Image URL to attach")
    parser.add_argument("--audio", help="Audio URL to attach")
    parser.add_argument("--report", help="Report/PDF URL to attach")
    parser.add_argument("--sandbox", action="store_true", help="Use sandbox APNs")
    parser.add_argument("--test", action="store_true", help="Send test notification")
    parser.add_argument("--test-image", action="store_true", help="Send test notification with image")
    parser.add_argument("--test-audio", action="store_true", help="Send test notification with audio")
    parser.add_argument("--test-report", action="store_true", help="Send test notification with report")
    parser.add_argument("--test-actions", action="store_true", help="Send test notification with action buttons")
    args = parser.parse_args()

    # Load config
    config = load_config()
    use_sandbox = args.sandbox or config.get("use_sandbox", False)

    # Handle test modes
    message_id = args.message_id or "test-" + str(int(time.time()))
    body = args.body or args.preview
    title = args.title
    category = args.category
    image_url = args.image
    audio_url = args.audio
    report_url = args.report

    if args.test:
        body = "This is a test notification from Sven!"

    if args.test_actions:
        body = "üëç Test notification with action buttons! Try the Like, Reply, and Dislike buttons below."
        category = "MESSAGE_CATEGORY"

    if args.test_image:
        body = "üñºÔ∏è Test notification with image attachment!"
        # Use a sample image (Claude logo)
        image_url = "https://www.anthropic.com/images/icons/apple-touch-icon.png"
        category = "IMAGE_CATEGORY"

    if args.test_audio:
        body = "üîä Test notification with audio! Tap 'Play' to hear the message."
        # Note: audio_url would need to be a real audio file URL
        category = "AUDIO_CATEGORY"

    if args.test_report:
        body = "üìÑ Test notification with PDF report! Tap 'View' to open."
        category = "REPORT_CATEGORY"

    if not body:
        parser.print_help()
        sys.exit(1)

    # Load registered APNs tokens
    if not APNS_TOKENS_PATH.exists():
        print("No APNs tokens registered yet", file=sys.stderr)
        sys.exit(0)

    tokens = json.loads(APNS_TOKENS_PATH.read_text())

    if not tokens:
        print("No APNs tokens registered", file=sys.stderr)
        sys.exit(0)

    print(f"Sending push to {len(tokens)} device(s)...")
    print(f"  Category: {category}")
    if image_url:
        print(f"  Image: {image_url}")
    if audio_url:
        print(f"  Audio: {audio_url}")
    if report_url:
        print(f"  Report: {report_url}")

    # Send to all registered devices
    success_count = 0
    for device_token, apns_token in tokens.items():
        if send_notification(
            apns_token=apns_token,
            message_id=message_id,
            body=body,
            config=config,
            sandbox=use_sandbox,
            category=category,
            title=title,
            image_url=image_url,
            audio_url=audio_url,
            report_url=report_url,
        ):
            success_count += 1

    print(f"Sent {success_count}/{len(tokens)} notifications")


if __name__ == "__main__":
    main()
