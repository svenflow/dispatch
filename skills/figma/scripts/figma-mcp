#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = ["httpx", "rich"]
# ///
"""
Figma MCP CLI - Make authenticated calls to Figma's MCP server.
Pulls OAuth tokens from macOS keychain (stored by Claude Code).

Usage:
    figma-mcp list-tools              # List available MCP tools
    figma-mcp call <tool> [args...]   # Call an MCP tool with JSON args
    figma-mcp generate-diagram "prompt"  # Shortcut for FigJam diagram
"""

import json
import subprocess
import sys
from typing import Any

import httpx
from rich import print as rprint
from rich.json import JSON


MCP_URL = "https://mcp.figma.com/mcp"
KEYCHAIN_SERVICE = "Claude Code-credentials"


def get_figma_token() -> str:
    """Extract Figma OAuth access token from macOS keychain."""
    try:
        result = subprocess.run(
            ["security", "find-generic-password", "-s", KEYCHAIN_SERVICE, "-w"],
            capture_output=True,
            text=True,
            check=True,
        )
        creds = json.loads(result.stdout.strip())

        # Find the figma OAuth entry
        mcp_oauth = creds.get("mcpOAuth", {})
        for key, value in mcp_oauth.items():
            if key.startswith("figma"):
                return value["accessToken"]

        raise ValueError("No Figma OAuth token found in keychain")
    except subprocess.CalledProcessError as e:
        raise RuntimeError(f"Failed to read keychain: {e.stderr}")
    except (json.JSONDecodeError, KeyError) as e:
        raise RuntimeError(f"Failed to parse credentials: {e}")


def mcp_request(method: str, params: dict | None = None) -> Any:
    """Make an MCP JSON-RPC request to Figma."""
    token = get_figma_token()

    payload = {
        "jsonrpc": "2.0",
        "id": 1,
        "method": method,
    }
    if params:
        payload["params"] = params

    headers = {
        "Authorization": f"Bearer {token}",
        "Content-Type": "application/json",
        "Accept": "application/json, text/event-stream",
    }

    with httpx.Client(timeout=60.0) as client:
        response = client.post(MCP_URL, json=payload, headers=headers)
        response.raise_for_status()

        content_type = response.headers.get("content-type", "")

        # Handle SSE response
        if "text/event-stream" in content_type:
            # Parse SSE - look for data: lines
            lines = response.text.split("\n")
            for line in lines:
                if line.startswith("data:"):
                    data = line[5:].strip()
                    if data:
                        result = json.loads(data)
                        if "error" in result:
                            raise RuntimeError(f"MCP error: {result['error']}")
                        return result.get("result")
            raise RuntimeError("No data in SSE response")
        else:
            # Regular JSON response
            result = response.json()
            if "error" in result:
                raise RuntimeError(f"MCP error: {result['error']}")
            return result.get("result")


def list_tools():
    """List available MCP tools."""
    result = mcp_request("tools/list")
    tools = result.get("tools", [])

    print(f"\n{len(tools)} available tools:\n")
    for tool in tools:
        name = tool.get("name", "?")
        desc = tool.get("description", "No description")
        # Truncate description for readability
        if len(desc) > 100:
            desc = desc[:100] + "..."
        print(f"  {name}")
        print(f"    {desc}\n")


def call_tool(tool_name: str, arguments: dict):
    """Call an MCP tool with arguments."""
    result = mcp_request("tools/call", {
        "name": tool_name,
        "arguments": arguments,
    })
    return result


def generate_diagram(prompt: str):
    """Shortcut to generate a FigJam diagram."""
    print(f"Generating FigJam diagram: {prompt}")
    result = call_tool("generate_diagram", {
        "prompt": prompt,
    })
    return result


def main():
    if len(sys.argv) < 2:
        print(__doc__)
        sys.exit(1)

    command = sys.argv[1]

    try:
        if command == "list-tools":
            list_tools()

        elif command == "call":
            if len(sys.argv) < 3:
                print("Usage: figma-mcp call <tool_name> [json_args]")
                sys.exit(1)

            tool_name = sys.argv[2]
            args = {}
            if len(sys.argv) > 3:
                # Join remaining args and parse as JSON
                args = json.loads(" ".join(sys.argv[3:]))

            result = call_tool(tool_name, args)
            rprint(JSON(json.dumps(result, indent=2)))

        elif command == "generate-diagram":
            if len(sys.argv) < 3:
                print("Usage: figma-mcp generate-diagram 'prompt'")
                sys.exit(1)

            prompt = " ".join(sys.argv[2:])
            result = generate_diagram(prompt)
            rprint(JSON(json.dumps(result, indent=2)))

        elif command == "token":
            # Debug: show token (masked)
            token = get_figma_token()
            print(f"Token: {token[:10]}...{token[-4:]}")

        else:
            print(f"Unknown command: {command}")
            print(__doc__)
            sys.exit(1)

    except Exception as e:
        print(f"Error: {e}", file=sys.stderr)
        sys.exit(1)


if __name__ == "__main__":
    main()
