#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "requests",
#     "rich",
# ]
# ///
"""
Vermont Real Estate Company (vermontrealestatecompany.com) property lookup CLI.

NO COOKIES REQUIRED - uses embedded JSON-LD schema.org data.

Usage:
    vtrec lookup "https://www.vermontrealestatecompany.com/real-estate/206-conway-road-starksboro-vt-05487/5076545/191348686"
    vtrec lookup 5076545  # MLS number
"""

import argparse
import json
import re
import requests
from rich.console import Console
from rich.table import Table

console = Console()

HEADERS = {
    "User-Agent": "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36"
}

def extract_property_data(html: str) -> dict:
    """Extract property data from HTML using schema.org/JSON-LD and regex patterns."""
    result = {}

    # Find the SingleFamilyResidence JSON-LD block
    sfr_start = html.find('"@type": "SingleFamilyResidence"')
    if sfr_start > 0:
        brace_pos = html.rfind('{', 0, sfr_start)
        depth = 0
        for i, c in enumerate(html[brace_pos:], brace_pos):
            if c == '{':
                depth += 1
            elif c == '}':
                depth -= 1
                if depth == 0:
                    json_str = html[brace_pos:i+1]
                    try:
                        data = json.loads(json_str)
                        result['name'] = data.get('name')
                        result['description'] = data.get('description')
                        result['url'] = data.get('url')

                        if data.get('address'):
                            result['street'] = data['address'].get('streetAddress')
                            result['city'] = data['address'].get('addressLocality')
                            result['state'] = data['address'].get('addressRegion')
                            result['zip'] = data['address'].get('postalCode')

                        if data.get('geo'):
                            result['lat'] = data['geo'].get('latitude')
                            result['lng'] = data['geo'].get('longitude')

                        if data.get('floorSize'):
                            result['sqft'] = int(data['floorSize'].get('value', 0))
                    except (json.JSONDecodeError, ValueError):
                        pass
                    break

    # Extract additional fields via regex
    patterns = {
        'price': (r'"price"\s*:\s*"?(\d+)"?', int),
        'beds': (r'"numberOfBedrooms"\s*:\s*"?(\d+)"?', int),
        'baths': (r'"numberOfBathroomsTotal"\s*:\s*"?(\d+)"?', int),
        'lot_acres': (r'"lotSize"[^}]+"value"\s*:\s*"?([0-9.]+)"?', float),
        'year_built': (r'"yearBuilt"\s*:\s*"?(\d+)"?', int),
    }

    for name, (pattern, converter) in patterns.items():
        if name not in result:
            match = re.search(pattern, html)
            if match:
                try:
                    result[name] = converter(match.group(1))
                except ValueError:
                    pass

    # MLS number from URL or page
    mls_match = re.search(r'/(\d{7})/\d+/?$', html) or re.search(r'MLS#?\s*:?\s*(\d+)', html)
    if mls_match:
        result['mls'] = mls_match.group(1)

    return result

def lookup_property(url_or_mls: str) -> dict:
    """Look up a property by URL or MLS number."""
    if url_or_mls.startswith('http'):
        url = url_or_mls
    else:
        # It's an MLS number - we need to search for it
        # For now, return an error - would need Chrome to search
        return {"error": "MLS search requires the full URL. Go to vermontrealestatecompany.com and find the listing URL."}

    response = requests.get(url, headers=HEADERS)
    if response.status_code != 200:
        return {"error": f"HTTP {response.status_code}"}

    data = extract_property_data(response.text)
    if not data:
        return {"error": "Could not extract property data"}

    return data

def format_property(data: dict) -> None:
    """Pretty print property data."""
    if 'error' in data:
        console.print(f"[red]Error: {data['error']}[/red]")
        return

    console.print("\n[bold green]Vermont Real Estate Company Listing[/bold green]")

    table = Table(show_header=False)
    table.add_column("Field", style="cyan", width=15)
    table.add_column("Value")

    if data.get('name'):
        table.add_row("Address", data['name'])
    if data.get('price'):
        table.add_row("Price", f"${data['price']:,}")
    if data.get('beds'):
        table.add_row("Beds", str(data['beds']))
    if data.get('baths'):
        table.add_row("Baths", str(data['baths']))
    if data.get('sqft'):
        table.add_row("Sqft", f"{data['sqft']:,}")
    if data.get('lot_acres'):
        table.add_row("Lot Size", f"{data['lot_acres']:.2f} acres")
    if data.get('year_built'):
        table.add_row("Year Built", str(data['year_built']))
    if data.get('mls'):
        table.add_row("MLS#", data['mls'])

    console.print(table)

    if data.get('description'):
        console.print(f"\n[bold]Description:[/bold]")
        console.print(data['description'][:500] + "..." if len(data.get('description', '')) > 500 else data.get('description', ''))

def main():
    parser = argparse.ArgumentParser(description="Vermont Real Estate Company property lookup")
    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # Lookup command
    lookup_parser = subparsers.add_parser("lookup", help="Look up a property by URL")
    lookup_parser.add_argument("url", help="Full URL to the property listing")
    lookup_parser.add_argument("--json", action="store_true", help="Output raw JSON")

    args = parser.parse_args()

    if args.command == "lookup":
        data = lookup_property(args.url)
        if args.json:
            print(json.dumps(data, indent=2))
        else:
            format_property(data)
    else:
        parser.print_help()
        console.print("\n[yellow]Note: For searching, go to vermontrealestatecompany.com and copy the listing URL[/yellow]")

if __name__ == "__main__":
    main()
