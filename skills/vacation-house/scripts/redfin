#!/usr/bin/env -S uv run --script
# /// script
# requires-python = ">=3.11"
# dependencies = [
#     "requests",
#     "rich",
# ]
# ///
"""
Redfin property search CLI.

Extracts cookies from Chrome session to bypass bot protection, then queries Redfin APIs.

Usage:
    redfin search "206 Conway Road, Starksboro VT"
    redfin details 91421357
    redfin streetview "206 Conway Road, Starksboro VT" --save /tmp/sv.jpg
    redfin aerial "206 Conway Road, Starksboro VT" --save /tmp/aerial.jpg
"""

import argparse
import json
import os
import subprocess
import sys
import urllib.parse
import requests
from rich.console import Console
from rich.table import Table

console = Console()

CHROME_CLI = os.path.expanduser("~/.claude/skills/chrome-control/scripts/chrome")

def get_chrome_cookies() -> str:
    """Extract Redfin cookies from Chrome via the chrome-control extension."""
    # First check if there's a redfin tab open
    result = subprocess.run([CHROME_CLI, "tabs"], capture_output=True, text=True)

    redfin_tab = None
    lines = result.stdout.strip().split('\n')
    for i, line in enumerate(lines):
        # URL lines contain redfin.com, tab ID is on the line before
        if 'redfin.com' in line.lower():
            # Tab ID is first word of previous line (format: "tab_id  title")
            if i > 0:
                redfin_tab = lines[i-1].split()[0]
            break
        # Or check if this line starts with a tab_id and has redfin in title
        parts = line.split()
        if len(parts) >= 2 and parts[0].isdigit() and 'redfin' in line.lower():
            redfin_tab = parts[0]
            break

    if not redfin_tab:
        # Open redfin to get cookies
        console.print("[yellow]Opening Redfin to get fresh cookies...[/yellow]")
        result = subprocess.run([CHROME_CLI, "open", "https://www.redfin.com"], capture_output=True, text=True)
        # Extract tab ID from output like "Opened tab 123456: https://..."
        import re
        match = re.search(r'Opened tab (\d+)', result.stdout)
        if match:
            redfin_tab = match.group(1)

        if not redfin_tab:
            raise RuntimeError("Could not open Redfin tab")

        # Wait for page to load
        import time
        time.sleep(3)

    # Extract cookies via JS
    result = subprocess.run(
        [CHROME_CLI, "js", redfin_tab, "document.cookie"],
        capture_output=True, text=True
    )

    if result.returncode != 0:
        raise RuntimeError(f"Could not get cookies: {result.stderr}")

    return result.stdout.strip()

def get_google_api_key() -> str:
    """Get Google API key from keychain."""
    result = subprocess.run(
        ['security', 'find-generic-password', '-s', 'google-api-key', '-w'],
        capture_output=True, text=True
    )
    if result.returncode != 0:
        raise RuntimeError("Could not get google-api-key from keychain")
    return result.stdout.strip()

def make_redfin_request(endpoint: str, params: dict, cookies: str) -> dict:
    """Make a request to Redfin's stingray API."""
    headers = {
        'User-Agent': 'Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/131.0.0.0 Safari/537.36',
        'Accept': '*/*',
        'Accept-Language': 'en-US,en;q=0.9',
        'Referer': 'https://www.redfin.com/',
        'Cookie': cookies,
    }

    url = f"https://www.redfin.com/stingray/{endpoint}"
    response = requests.get(url, params=params, headers=headers)
    response.raise_for_status()

    # Redfin prefixes response with "{}&&"
    text = response.text
    if text.startswith('{}&&'):
        text = text[4:]

    return json.loads(text)

def search_address(query: str, cookies: str) -> dict:
    """Search for a property by address."""
    return make_redfin_request('do/location-autocomplete', {'location': query, 'v': 2}, cookies)

def get_property_details(property_id: str, cookies: str, url_path: str = None) -> dict:
    """Get detailed property information."""
    result = {}

    # If we have the full URL path, use it for initial info
    if url_path:
        initial = make_redfin_request('api/home/details/initialInfo', {'path': url_path}, cookies)
        result['initial'] = initial

    # Get below the fold data with propertyId and accessLevel
    try:
        btf = make_redfin_request('api/home/details/belowTheFold', {
            'propertyId': property_id,
            'accessLevel': 1,
        }, cookies)
        result['below_the_fold'] = btf
    except Exception as e:
        result['below_the_fold_error'] = str(e)

    # Also try the above the fold endpoint
    try:
        atf = make_redfin_request('api/home/details/aboveTheFold', {
            'propertyId': property_id,
            'accessLevel': 1,
        }, cookies)
        result['above_the_fold'] = atf
    except Exception as e:
        result['above_the_fold_error'] = str(e)

    return result

def get_streetview_url(address: str, api_key: str, size: str = "600x400") -> str:
    """Get Street View static image URL."""
    params = {
        'size': size,
        'location': address,
        'key': api_key,
    }
    base_url = "https://maps.googleapis.com/maps/api/streetview"
    return f"{base_url}?{urllib.parse.urlencode(params)}"

def get_aerial_url(address: str, api_key: str, zoom: int = 18, size: str = "600x400") -> str:
    """Get aerial/satellite view URL."""
    params = {
        'center': address,
        'zoom': zoom,
        'size': size,
        'maptype': 'satellite',
        'key': api_key,
    }
    base_url = "https://maps.googleapis.com/maps/api/staticmap"
    return f"{base_url}?{urllib.parse.urlencode(params)}"

def download_image(url: str, save_path: str) -> bool:
    """Download image from URL."""
    response = requests.get(url)
    if response.status_code == 200:
        with open(save_path, 'wb') as f:
            f.write(response.content)
        return True
    return False

def format_search_results(response: dict) -> None:
    """Pretty print search results."""
    payload = response.get('payload', {})

    exact = payload.get('exactMatch')
    if exact:
        console.print("\n[bold green]Exact Match:[/bold green]")
        table = Table(show_header=False)
        table.add_column("Field", style="cyan")
        table.add_column("Value")

        table.add_row("Name", exact.get('name', 'N/A'))
        table.add_row("Location", exact.get('subName', 'N/A'))
        table.add_row("Property ID", str(exact.get('id', 'N/A')).replace('1_', ''))
        table.add_row("URL", f"https://redfin.com{exact.get('url', '')}")
        table.add_row("Active", "Yes" if exact.get('active') else "No")

        console.print(table)
        return

    sections = payload.get('sections', [])
    for section in sections:
        console.print(f"\n[bold]{section.get('name', 'Results')}:[/bold]")
        rows = section.get('rows', [])

        if rows:
            table = Table()
            table.add_column("Name", style="cyan")
            table.add_column("Location")
            table.add_column("ID")
            table.add_column("Active")

            for row in rows[:10]:
                prop_id = str(row.get('id', 'N/A')).replace('1_', '')
                table.add_row(
                    row.get('name', 'N/A'),
                    row.get('subName', 'N/A'),
                    prop_id,
                    "Yes" if row.get('active') else "No"
                )

            console.print(table)

def main():
    parser = argparse.ArgumentParser(description="Redfin property search CLI")
    subparsers = parser.add_subparsers(dest="command", help="Commands")

    # Search command
    search_parser = subparsers.add_parser("search", help="Search for properties by address")
    search_parser.add_argument("query", help="Address or location to search")
    search_parser.add_argument("--json", action="store_true", help="Output raw JSON")

    # Details command
    details_parser = subparsers.add_parser("details", help="Get property details")
    details_parser.add_argument("property_id", help="Redfin property ID")
    details_parser.add_argument("--json", action="store_true", help="Output raw JSON")

    # Street View command
    sv_parser = subparsers.add_parser("streetview", help="Get Street View image")
    sv_parser.add_argument("address", help="Property address")
    sv_parser.add_argument("--save", help="Save image to path")
    sv_parser.add_argument("--size", default="600x400", help="Image size")

    # Aerial command
    aerial_parser = subparsers.add_parser("aerial", help="Get aerial/satellite image")
    aerial_parser.add_argument("address", help="Property address")
    aerial_parser.add_argument("--save", help="Save image to path")
    aerial_parser.add_argument("--size", default="600x400", help="Image size")
    aerial_parser.add_argument("--zoom", type=int, default=18, help="Zoom level")

    args = parser.parse_args()

    if args.command == "search":
        cookies = get_chrome_cookies()
        response = search_address(args.query, cookies)

        if args.json:
            print(json.dumps(response, indent=2))
        else:
            format_search_results(response)

            # Extract property ID for convenience
            payload = response.get('payload', {})
            exact = payload.get('exactMatch')
            if exact:
                prop_id = str(exact.get('id', '')).replace('1_', '')
                console.print(f"\n[dim]For details: redfin details {prop_id}[/dim]")

    elif args.command == "details":
        cookies = get_chrome_cookies()
        response = get_property_details(args.property_id, cookies)

        if args.json:
            print(json.dumps(response, indent=2, default=str))
        else:
            # Extract data from different sources
            atf = response.get('above_the_fold', {}).get('payload', {})
            btf = response.get('below_the_fold', {}).get('payload', {})

            console.print("\n[bold green]Property Details:[/bold green]")
            table = Table(show_header=False)
            table.add_column("Field", style="cyan", width=20)
            table.add_column("Value")

            # Address from above_the_fold
            address_info = atf.get('addressSectionInfo', {})
            if address_info:
                street = atf.get('streetAddress', {}).get('assembledAddress', '')
                if street:
                    table.add_row("Address", street)

                # Status and price
                status = address_info.get('status', {}).get('displayValue', 'N/A')
                table.add_row("Status", status)

                price_info = address_info.get('priceInfo', {})
                if price_info:
                    amount = price_info.get('amount')
                    label = price_info.get('label', 'Price')
                    if amount:
                        table.add_row(label, f"${amount:,}")

            # Public records info
            public_records = btf.get('publicRecordsInfo', {})
            basic = public_records.get('basicInfo', {}) if public_records else {}

            if basic:
                if basic.get('beds'):
                    table.add_row("Beds", str(basic['beds']))
                if basic.get('baths'):
                    table.add_row("Baths", str(basic['baths']))
                sqft = basic.get('sqFtFinished') or basic.get('totalSqFt') or basic.get('sqFt')
                if sqft:
                    table.add_row("Sqft", f"{sqft:,}")
                if basic.get('lotSqFt'):
                    acres = basic['lotSqFt'] / 43560
                    table.add_row("Lot Size", f"{basic['lotSqFt']:,} sqft ({acres:.2f} acres)")
                if basic.get('yearBuilt'):
                    table.add_row("Year Built", str(basic['yearBuilt']))
                if basic.get('propertyTypeName'):
                    table.add_row("Type", basic['propertyTypeName'])

            # Tax info
            tax_info = public_records.get('taxInfo', {}) if public_records else {}
            if tax_info:
                taxes = tax_info.get('taxesDue')
                if taxes:
                    table.add_row("Annual Taxes", f"${taxes:,.2f}")

            console.print(table)

    elif args.command == "streetview":
        api_key = get_google_api_key()
        url = get_streetview_url(args.address, api_key, args.size)

        if args.save:
            if download_image(url, args.save):
                console.print(f"[green]Saved to {args.save}[/green]")
            else:
                console.print("[red]Failed to download[/red]")
                sys.exit(1)
        else:
            print(url)

    elif args.command == "aerial":
        api_key = get_google_api_key()
        url = get_aerial_url(args.address, api_key, args.zoom, args.size)

        if args.save:
            if download_image(url, args.save):
                console.print(f"[green]Saved to {args.save}[/green]")
            else:
                console.print("[red]Failed to download[/red]")
                sys.exit(1)
        else:
            print(url)

    else:
        parser.print_help()

if __name__ == "__main__":
    main()
